<%- include('./partials/navback') %>

<main class="container mx-auto px-4 pt-20 pb-24">
    <!-- Header -->
    <div class="text-center mb-6">
        <div class="inline-flex items-center justify-center w-16 h-16 bg-gradient-to-br from-purple-500 to-pink-500 rounded-2xl shadow-lg mb-3">
            <span class="text-3xl">ðŸ“±</span>
        </div>
        <h1 class="text-2xl font-bold bg-gradient-to-r from-purple-600 to-pink-600 bg-clip-text text-transparent">Event Scanner</h1>
        <p class="text-xs text-gray-500 mt-1">Scan QR codes at entrance</p>
    </div>

    <!-- Today's Stats -->
    <div class="grid grid-cols-4 gap-2 mb-5">
        <div class="bg-gradient-to-br from-purple-50 to-purple-100 rounded-lg p-2 text-center">
            <div class="text-lg font-bold text-purple-700" id="stat-scanned"><%= stats.total_scanned_today %></div>
            <div class="text-[10px] text-purple-600">Scanned</div>
        </div>
        <div class="bg-gradient-to-br from-pink-50 to-pink-100 rounded-lg p-2 text-center">
            <div class="text-lg font-bold text-pink-700" id="stat-attendees"><%= stats.unique_attendees %></div>
            <div class="text-[10px] text-pink-600">Attendees</div>
        </div>
        <div class="bg-gradient-to-br from-yellow-50 to-yellow-100 rounded-lg p-2 text-center">
            <div class="text-lg font-bold text-yellow-700" id="stat-vvip"><%= stats.vvip_count %></div>
            <div class="text-[10px] text-yellow-600">VVIP</div>
        </div>
        <div class="bg-gradient-to-br from-orange-50 to-orange-100 rounded-lg p-2 text-center">
            <div class="text-lg font-bold text-orange-700" id="stat-vip"><%= stats.vip_count %></div>
            <div class="text-[10px] text-orange-600">VIP</div>
        </div>
    </div>

    <!-- Scanner Interface -->
    <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-5 mb-5">
        <h3 class="text-sm font-semibold text-gray-700 mb-3">ðŸ“· Scan QR Code</h3>
        
        <!-- Camera/Manual Input Toggle -->
        <div class="flex space-x-2 mb-4">
            <button onclick="switchMode('camera')" id="camera-mode-btn" class="flex-1 py-2 bg-purple-600 text-white rounded-lg text-sm font-medium">
                Camera
            </button>
            <button onclick="switchMode('manual')" id="manual-mode-btn" class="flex-1 py-2 bg-gray-100 text-gray-600 rounded-lg text-sm font-medium">
                Manual Entry
            </button>
        </div>

        <!-- Camera Mode -->
        <div id="camera-mode" class="space-y-3">
            <div id="qr-reader" class="w-full rounded-lg overflow-hidden"></div>
            <div id="qr-reader-results" class="text-center text-sm text-gray-600 py-2"></div>
            <button onclick="startScanner()" class="w-full py-2.5 bg-purple-600 text-white rounded-lg text-sm font-medium">
                Start Camera
            </button>
        </div>

        <!-- Manual Entry Mode -->
        <div id="manual-mode" class="space-y-3 hidden">
            <input type="text" id="manual-ticket-input" placeholder="Enter ticket ID or scan code" 
                   class="w-full px-4 py-2.5 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-purple-500 focus:border-transparent">
            <button onclick="validateManualTicket()" class="w-full py-2.5 bg-purple-600 text-white rounded-lg text-sm font-medium">
                Validate Ticket
            </button>
        </div>

        <!-- Scan Result -->
        <div id="scan-result" class="mt-4 p-4 rounded-lg hidden"></div>
    </div>

    <!-- Recent Valid Tickets (Not Used) -->
    <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-5 mb-5">
        <h3 class="text-sm font-semibold text-gray-700 mb-3 flex items-center">
            <span class="w-2 h-2 bg-green-500 rounded-full mr-2"></span>
            Valid Tickets (<%= validTickets.length %>)
        </h3>
        
        <div class="space-y-2 max-h-48 overflow-y-auto" id="valid-tickets-list">
            <% validTickets.forEach(ticket => { %>
            <div class="flex items-center justify-between p-2 bg-gray-50 rounded-lg text-xs">
                <div>
                    <div class="font-medium text-gray-800"><%= ticket.username %></div>
                    <div class="text-gray-500">#<%= ticket.paystack_reference.slice(-6) %></div>
                </div>
                <div>
                    <span class="px-2 py-1 bg-purple-100 text-purple-700 rounded-full text-[10px] font-medium">
                        <%= ticket.ticket_type %>
                    </span>
                </div>
            </div>
            <% }) %>
        </div>
    </div>

    <!-- Recent Scans -->
    <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-5">
        <h3 class="text-sm font-semibold text-gray-700 mb-3">ðŸ“‹ Recent Scans</h3>
        
        <div class="space-y-2 max-h-48 overflow-y-auto" id="recent-scans-list">
            <% recentScans.forEach(scan => { %>
            <div class="flex items-center justify-between p-2 bg-gray-50 rounded-lg text-xs">
                <div>
                    <div class="font-medium text-gray-800"><%= scan.username %></div>
                    <div class="text-gray-500"><%= new Date(scan.used_at).toLocaleTimeString() %></div>
                </div>
                <div class="text-right">
                    <span class="px-2 py-1 bg-<%= scan.ticket_type === 'vvip' ? 'yellow' : scan.ticket_type === 'vip' ? 'purple' : 'gray' %>-100 text-<%= scan.ticket_type === 'vvip' ? 'yellow' : scan.ticket_type === 'vip' ? 'purple' : 'gray' %>-700 rounded-full text-[10px] font-medium">
                        <%= scan.ticket_type %>
                    </span>
                </div>
            </div>
            <% }) %>
        </div>
    </div>
</main>

<!-- Include html5-qrcode library -->
<script src="https://unpkg.com/html5-qrcode/minified/html5-qrcode.min.js"></script>

<script>
let html5QrCode = null;
let scannerActive = false;
let currentMode = 'camera';

// Initialize QR scanner
function initQRScanner() {
    const qrReaderElement = document.getElementById('qr-reader');
    if (!qrReaderElement) return;
    
    // Clear any existing instance
    if (html5QrCode) {
        html5QrCode.stop().then(() => {
            html5QrCode.clear();
            html5QrCode = null;
        });
    }
    
    // Create new instance
    html5QrCode = new Html5Qrcode("qr-reader");
}

// Start scanner
async function startScanner() {
    const qrReaderElement = document.getElementById('qr-reader');
    if (!qrReaderElement) return;
    
    const resultDiv = document.getElementById('qr-reader-results');
    resultDiv.innerHTML = 'Starting camera...';
    
    const qrCodeSuccessCallback = (decodedText, decodedResult) => {
        // Stop scanning once we get a result
        html5QrCode.stop().then(() => {
            resultDiv.innerHTML = `QR Code detected: ${decodedText.substring(0, 20)}...`;
            // Validate the ticket
            validateTicket(decodedText);
        }).catch(err => {
            console.error('Error stopping scanner:', err);
        });
    };
    
    const config = { 
        fps: 10, 
        qrbox: { width: 250, height: 250 },
        aspectRatio: 1.0
    };
    
    try {
        await html5QrCode.start(
            { facingMode: "environment" }, 
            config, 
            qrCodeSuccessCallback
        );
        scannerActive = true;
        resultDiv.innerHTML = 'Scanner active - point camera at QR code';
    } catch (err) {
        console.error('Error starting scanner:', err);
        resultDiv.innerHTML = 'Error starting camera: ' + err.message;
    }
}

// Stop scanner
function stopScanner() {
    if (html5QrCode && scannerActive) {
        html5QrCode.stop().then(() => {
            scannerActive = false;
            document.getElementById('qr-reader-results').innerHTML = 'Scanner stopped';
        }).catch(err => {
            console.error('Error stopping scanner:', err);
        });
    }
}

// Switch between camera and manual mode
function switchMode(mode) {
    currentMode = mode;
    
    // Update buttons
    document.getElementById('camera-mode-btn').className = mode === 'camera' 
        ? 'flex-1 py-2 bg-purple-600 text-white rounded-lg text-sm font-medium'
        : 'flex-1 py-2 bg-gray-100 text-gray-600 rounded-lg text-sm font-medium';
    
    document.getElementById('manual-mode-btn').className = mode === 'manual'
        ? 'flex-1 py-2 bg-purple-600 text-white rounded-lg text-sm font-medium'
        : 'flex-1 py-2 bg-gray-100 text-gray-600 rounded-lg text-sm font-medium';
    
    // Show/hide modes
    document.getElementById('camera-mode').className = mode === 'camera' ? 'space-y-3' : 'hidden';
    document.getElementById('manual-mode').className = mode === 'manual' ? 'space-y-3' : 'hidden';
    
    // Stop scanner if switching away from camera mode
    if (mode !== 'camera') {
        stopScanner();
    } else {
        initQRScanner();
    }
}

// Validate ticket via API
async function validateTicket(ticketData) {
    try {
        // Try to parse as JSON first (in case it's a QR code with JSON data)
        let ticketId = ticketData;
        try {
            const parsed = JSON.parse(ticketData);
            ticketId = parsed.ticketId || parsed.reference || ticketData;
        } catch {
            // Not JSON, use as is
        }
        
        const response = await fetch('/scanner/validate', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ ticketData: ticketId })
        });
        
        const data = await response.json();
        
        if (data.valid) {
            // Ask for confirmation to scan
            if (confirm(`âœ… Valid ${data.ticket.type.toUpperCase()} ticket for ${data.ticket.username}\n\nClick OK to mark as used`)) {
                scanTicket(data.ticket.id);
            } else {
                showResult('Scan cancelled', 'info');
                // Restart scanner if in camera mode
                if (currentMode === 'camera' && scannerActive) {
                    setTimeout(() => startScanner(), 1000);
                }
            }
        } else {
            showResult(data.message, 'error', data.ticket);
            // Restart scanner if in camera mode
            if (currentMode === 'camera' && scannerActive) {
                setTimeout(() => startScanner(), 2000);
            }
        }
    } catch (error) {
        console.error('Validation error:', error);
        showResult('Error validating ticket', 'error');
    }
}

// Scan ticket (mark as used)
async function scanTicket(ticketId) {
    try {
        const response = await fetch('/scanner/scan', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ ticketId, action: 'entry' })
        });
        
        const data = await response.json();
        
        if (data.success) {
            showResult(data.message, 'success', data.ticket);
            
            // Update stats optimistically
            updateStats();
            
            // Refresh the page after 2 seconds to show updated lists
            setTimeout(() => location.reload(), 2000);
        } else {
            showResult(data.message, 'error', data.ticket);
            // Restart scanner if in camera mode
            if (currentMode === 'camera' && scannerActive) {
                setTimeout(() => startScanner(), 2000);
            }
        }
    } catch (error) {
        console.error('Scan error:', error);
        showResult('Error scanning ticket', 'error');
    }
}

// Manual ticket validation
function validateManualTicket() {
    const ticketInput = document.getElementById('manual-ticket-input').value.trim();
    if (!ticketInput) {
        alert('Please enter a ticket ID');
        return;
    }
    validateTicket(ticketInput);
}

// Show scan result
function showResult(message, type, ticket = null) {
    const resultDiv = document.getElementById('scan-result');
    resultDiv.className = `mt-4 p-4 rounded-lg ${
        type === 'success' ? 'bg-green-100 border border-green-200 text-green-800' :
        type === 'error' ? 'bg-red-100 border border-red-200 text-red-800' :
        'bg-blue-100 border border-blue-200 text-blue-800'
    }`;
    
    let html = `<p class="text-sm font-medium">${message}</p>`;
    
    if (ticket) {
        html += `
            <div class="mt-2 text-xs border-t ${type === 'success' ? 'border-green-200' : 'border-red-200'} pt-2">
                <div>Type: ${ticket.type || 'N/A'}</div>
                <div>Owner: ${ticket.username || 'N/A'}</div>
                ${ticket.purchased ? `<div>Purchased: ${ticket.purchased}</div>` : ''}
            </div>
        `;
    }
    
    resultDiv.innerHTML = html;
    resultDiv.classList.remove('hidden');
    
    // Clear manual input
    document.getElementById('manual-ticket-input').value = '';
}

// Update stats (called after successful scan)
async function updateStats() {
    try {
        const response = await fetch('/scanner/stats');
        const data = await response.json();
        
        if (data.success) {
            document.getElementById('stat-scanned').textContent = data.stats.total_scanned_today;
            document.getElementById('stat-attendees').textContent = data.stats.unique_attendees;
            document.getElementById('stat-vvip').textContent = data.stats.vvip_count;
            document.getElementById('stat-vip').textContent = data.stats.vip_count;
        }
    } catch (error) {
        console.error('Error updating stats:', error);
    }
}

// Initialize on page load
document.addEventListener('DOMContentLoaded', () => {
    initQRScanner();
});

// Cleanup on page unload
window.addEventListener('beforeunload', () => {
    stopScanner();
});

// Default to camera mode on load
switchMode('camera');
</script>